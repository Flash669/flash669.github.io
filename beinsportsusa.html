<head>
    <script type='text/javascript' src='//bitmovin-a.akamaihd.net/bitmovin-player/stable/7.8/bitmovinplayer.js'></script>
    <script src='https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js'></script>
    <script src='https://code.jquery.com/jquery-3.3.1.min.js'></script>
    <script>function override(url){
    if (url.indexOf("licensing.bitmovin.com/licensing") > -1) return "bm";
    if (url.indexOf("licensing.bitmovin.com/impression") > -1) return "impression";
    return url;
}

var open = XMLHttpRequest.prototype.open;
XMLHttpRequest.prototype.open = function() {
        var url = override(arguments[1]);
        arguments[1] = url;
        return open.apply(this, arguments);

}

function base64DecodeUint8Array(input) {
    var raw = window.atob(input);
    var rawLength = raw.length;
    var array = new Uint8Array(new ArrayBuffer(rawLength));

    for(i = 0; i < rawLength; i++){
        array[i] = raw.charCodeAt(i);
    }

    return array;
}

function ab2str(buf) {
    return String.fromCharCode.apply(null, new Uint8Array(buf));
}

function _Base64(t) {
    var e;
    if ("string" == typeof t)
        e = t;
    else if (t instanceof ArrayBuffer)
        e = String.fromCharCode.apply(null, new Uint8Array(t));
    else {
        if (!(t instanceof Uint8Array))
            return "";
        e = String.fromCharCode.apply(null, t)
    }
    return window.btoa(e)
}</script> 
</head>
<body>
    <div id="my-player"></div>
    <button id="unmute-btn">Desmutear</button>
    <script>
const initializeBitmovinPlayer = async () => {
  const context = this;

  const getWindow = () => {
    let windowObj;
    try {
      windowObj = Function("return (function() {}.constructor(\"return this\")( ));")();
    } catch (error) {
      windowObj = window;
    }
    return windowObj;
  };

  const globalContext = getWindow();
  const consoleObject = globalContext.console = globalContext.console || {};
  const consoleMethods = ["log", "warn", "info", "error", "exception", "table", "trace"];

  for (let methodIndex = 0; methodIndex < consoleMethods.length; methodIndex++) {
    const bindFunction = context.constructor.prototype.bind(context);
    const methodName = consoleMethods[methodIndex];
    const originalMethod = consoleObject[methodName] || bindFunction;

    bindFunction.__proto__ = context.bind(context);
    bindFunction.toString = originalMethod.toString.bind(originalMethod);
    consoleObject[methodName] = bindFunction;
  }

  try {
    const response = await fetch("https://cbd46b77.cdn.cms.movetv.com/playermetadata/sling/v1/api/channels/9125fbd1c6cd4c93b01387201878f063/current/schedule.qvt");
    const jsonData = await response.json();

    if (jsonData.playback_info && jsonData.playback_info.dash_manifest_url) {
      const playerConfig = {
        autoplay: false,
        muted: false,
      };

      const bitmovinConfig = {
        'playback': playerConfig,
        'key': "Y2tvaWtjY29lbSEqXyVrZG9lYTJzZT9yb201ZGFzaXMzMGRiMEElXzo=",
        'style': {
          'width': "100%",
          'aspectratio': "16:9",
          'controls': true,
        },
        'source': {
          'title': "Reproductor | Rustico TV",
          'description': "Estamos para Quedarnos",
          'dash': "https://images261-focus-opensocial.googleusercontent.com/gadgets/proxy?container=focus&url=" + jsonData.playback_info.dash_manifest_url,
          'drm': {
            'widevine': {
              'LA_URL': "https://p-drmwv.movetv.com/widevine/proxy",
              'prepareMessage': (x) => {
                return JSON.stringify({
                  'env': "production",
                  'user_id': "ca02b1e4-c4a8-11e7-bf6c-0e8187720418",
                  'channel_id': "9125fbd1c6cd4c93b01387201878f063",
                  'message': Array.from(new Uint8Array(x.message)),
                });
              },
            },
            'playready': {
              'LA_URL': "https://p-drmwv.movetv.com/widevine/proxy",
            },
          },
        },
        'network': {
          'preprocessHttpRequest': (requestType, httpRequest) => {
            if (requestType === bitmovin.player.network.REQUEST_TYPE.DRM_LICENSE_WIDEVINE) {
              httpRequest.method = "POST";
              const authorizationHeader = {
                name: "Authorization",
                value: "Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsImtpZCI6IjM1Mzg2NjY1LTMzNjQtNjMzNy0zMjY0LTM5MzUzNTY2Mzk2NCJ9.eyJ1c2VyX2d1aWQiOiJjYTAyYjFlNC1jNGE4LTExZTctYmY2Yy0wZTgxODc3MjA0MTgiLCJjaGFubmVsX2d1aWQiOiI5MTI1ZmJkMWM2Y2Q0YzkzYjAxMzg3MjAxODc4ZjA2MyIsImR5bmFfaWQiOiI2IiwicXZ0IjoiaHR0cHM6Ly9jYmQ0NmI3Ny5jZG4uY21zLm1vdmV0di5jb20vcGxheWVybWV0YWRhdGEvc2xpbmcvdjEvYXBpL2NoYW5uZWxzLzkxMjVmYmQxYzZjZDRjOTNiMDEzODcyMDE4NzhmMDYzL2N1cnJlbnQvc2NoZWR1bGUucXZ0In0.ix4rccvDyjR9-ZI1i6zQQ1pulwYBCM2uGmnaiJkk7erjHWv4oSmF3_0Rngugr0Dh_y1CFKi0B82MLe3eyBBORR_DmcId3iIzfE7_TzCvH-_1XZ3S-hO3Qo9k1AAwvPuFgcFabQmtlEHef07GEKPVHdHa34qaqq7QZ9QbQkgwIZY6Kl66-imOeysvZmpQ3Zo5PtL65ganfMtm3OWF4UfvQeeZ-xH50E8x5s4RPB-_7uJSdjvHWLRK3jE4aFPFjioHCSUlpaLZl8LX4fykTRmhqiLDEPNeXJMRQIV4YFKoPhRwV8OTDRn7HtQMX1YY-CGBHEWV4fLHBWDfhH3ZVkcVFw",
              };
              httpRequest.headers.push(authorizationHeader);
              return Promise.resolve(httpRequest);
            }

            if (httpRequest.url.includes(".mp4") || httpRequest.url.includes(".m4s")) {
              httpRequest.url = "https://images133-focus-opensocial.googleusercontent.com/gadgets/proxy?container=focus&url=" + httpRequest.url;
            }

            return httpRequest;
          },
        },
      };

      const bitmovinPlayer = bitmovin.player("my-player");

      bitmovinPlayer.setup(bitmovinConfig).then(
        (success) => {
          console.log("Successfully created bitmovin player instance");
          const unmuteButton = document.getElementById("unmute-btn");
          unmuteButton.addEventListener("click", () => {
            bitmovinPlayer.unmute();
            bitmovinPlayer.setVolume(90);
            unmuteButton.style.display = "none";
          });
        },
        (error) => {
          console.log("Error while creating bitmovin player instance", error);
        }
     

</script>
